import math
import numpy as np

print('loading hexagon sector vertiport configuration')


def pointy_hex_corner(center, size, i):
    angle_deg = 60 * i
    angle_rad = math.radians(angle_deg)
    return (center[0] + size * math.cos(angle_rad),
            center[1] + size * math.sin(angle_rad))


def pointy_hex_corner2(center, size, i):
    angle_deg = 60 * i + 30
    angle_rad = math.radians(angle_deg)
    return (center[0] + size * math.cos(angle_rad),
            center[1] + size * math.sin(angle_rad))


class Config:
    # experiment setting
    no_episodes = 1000000

    # airspace setting
    window_width = 800
    window_height = 800
    diagonal = window_height * math.sqrt(2)
    num_aircraft = 10
    EPISODES = 1000000
    G = 9.8
    tick = 30
    scale = 60  # 1 pixel = 60 meters

    # distance param
    minimum_separation = 926 / scale
    NMAC_dist = 150 / scale
    horizon_dist = 4000 / scale
    initial_min_dist = 3000 / scale
    goal_radius = 600 / scale

    # speed
    init_speed = 190 / 3.6 / scale
    min_speed = 45 / scale
    max_speed = 220 / 3.6 / scale
    # d_speed = 0 / scale
    speed_sigma = 5 / scale
    # position_sigma = 0 / scale

    # heading in rad TBD
    d_heading = math.radians(5)
    heading_sigma = math.radians(2)

    # MCTS algorithm
    no_simulations = 100
    search_depth = 3
    no_simulations_lite = 30
    search_depth_lite = 2
    simulate_frame = 10

    # reward setting
    NMAC_penalty = -10 / 10
    conflict_penalty = -5 / 10
    wall_penalty = -10 / 10
    step_penalty = -0.01 / 10
    goal_reward = 10 / 10
    conflict_coeff = 0.005
    goal_importance = 0.0005
    sparse_reward = True

    n_closest = 4

    # vertiport parameter
    start_safe_dist = 3 * minimum_separation
    time_interval_lower = 60
    time_interval_upper = 120
    vertiport_loc = np.zeros([7, 2])
    vertiport_center = np.array([window_width / 2, window_height / 2])
    vertiport_loc[0, :] = vertiport_center
    for i in range(1, 7):
        vertiport_loc[i, :] = pointy_hex_corner(vertiport_center, size=300, i=i)

    # point
    point_len = 4
    point = np.array([[-point_len, -point_len],
                      [point_len, -point_len],
                      [point_len, point_len],
                      [-point_len, point_len],
                      [-point_len, -point_len]])

    # square
    square_len = 5
    sector_exit_len = 15
    vertices = np.array([[-sector_exit_len, -square_len],
                         [sector_exit_len, -square_len],
                         [sector_exit_len, square_len],
                         [-sector_exit_len, square_len],
                         [-sector_exit_len, -square_len]])

    # sector vertices
    sector_vertices = np.zeros([7, 6, 2])
    for i in range(7):
        for j in range(6):
            sector_vertices[i, j, :] = pointy_hex_corner2(vertiport_loc[i], size=300 / np.sqrt(3), i=j)

    # sector_len_exits = {
    #     0: np.array(
    #         [[[550., 371.13248654],
    #           [550., 361.13248654],
    #           [550., 381.13248654]],
    #
    #          [[500., 515.47005384],
    #           [508.66025404, 510.47005384],
    #           [491.33974596, 520.47005384]],
    #
    #          [[350., 544.3375673],
    #           [358.66025404, 549.3375673],
    #           [341.33974596, 539.3375673]],
    #
    #          [[250., 428.86751346],
    #           [250., 438.86751346],
    #           [250., 418.86751346]],
    #
    #          [[300., 284.52994616],
    #           [291.33974596, 289.52994616],
    #           [308.66025404, 279.52994616]],
    #
    #          [[450., 255.6624327],
    #           [441.33974596, 250.6624327],
    #           [458.66025404, 260.6624327]]]
    #     ),
    #
    #     1: np.array(
    #         [[[400., 688.67513459],
    #           [400., 698.67513459],
    #           [400., 678.67513459]],
    #
    #          [[450., 544.3375673],
    #           [441.33974596, 549.3375673],
    #           [458.66025404, 539.3375673]],
    #
    #          [[600., 515.47005384],
    #           [591.33974596, 510.47005384],
    #           [608.66025404, 520.47005384]]]
    #     ),
    #
    #     2: np.array(
    #         [[[150., 544.3375673],
    #           [141.33974596, 549.3375673],
    #           [158.66025404, 539.3375673]],
    #
    #          [[300., 515.47005384],
    #           [291.33974596, 510.47005384],
    #           [308.66025404, 520.47005384]],
    #
    #          [[400., 630.94010768],
    #           [400., 620.94010768],
    #           [400., 640.94010768]]]
    #     ),
    #
    #     3: np.array(
    #         [[[150., 255.6624327],
    #           [141.33974596, 250.6624327],
    #           [158.66025404, 260.6624327]],
    #
    #          [[250., 371.13248654],
    #           [250., 361.13248654],
    #           [250., 381.13248654]],
    #
    #          [[200., 515.47005384],
    #           [208.66025404, 510.47005384],
    #           [191.33974596, 520.47005384]]]
    #     ),
    #
    #     4: np.array(
    #         [[[400., 111.32486541],
    #           [400., 101.32486541],
    #           [400., 121.32486541]],
    #
    #          [[350., 255.6624327],
    #           [358.66025404, 250.6624327],
    #           [341.33974596, 260.6624327]],
    #
    #          [[200., 284.52994616],
    #           [208.66025404, 289.52994616],
    #           [191.33974596, 279.52994616]]]
    #     ),
    #
    #     5: np.array(
    #         [[[650., 255.6624327],
    #           [658.66025404, 250.6624327],
    #           [641.33974596, 260.6624327]],
    #
    #          [[500., 284.52994616],
    #           [508.66025404, 289.52994616],
    #           [491.33974596, 279.52994616]],
    #
    #          [[400., 169.05989232],
    #           [400., 179.05989232],
    #           [400., 159.05989232]]]
    #     ),
    #
    #     6: np.array(
    #         [[[650., 544.3375673],
    #           [658.66025404, 549.3375673],
    #           [641.33974596, 539.3375673]],
    #
    #          [[550., 428.86751346],
    #           [550., 438.86751346],
    #           [550., 418.86751346]],
    #
    #          [[600., 284.52994616],
    #           [591.33974596, 289.52994616],
    #           [608.66025404, 279.52994616]]]
    #     )}

    sector_len_exits = {
        0: np.array(
            [[[550., 371.13248654],
              [550., 356.13248654],
              [550., 386.13248654]],

             [[500., 515.47005384],
              [512.99038106, 507.97005384],
              [487.00961894, 522.97005384]],

             [[350., 544.3375673],
              [362.99038106, 551.8375673],
              [337.00961894, 536.8375673]],

             [[250., 428.86751346],
              [250., 443.86751346],
              [250., 413.86751346]],

             [[300., 284.52994616],
              [287.00961894, 292.02994616],
              [312.99038106, 277.02994616]],

             [[450., 255.6624327],
              [437.00961894, 248.1624327],
              [462.99038106, 263.1624327]]]
        ),

        1: np.array(
            [[[400., 688.67513459],
              [400., 703.67513459],
              [400., 673.67513459]],

             [[450., 544.3375673],
              [437.00961894, 551.8375673],
              [462.99038106, 536.8375673]],

             [[600., 515.47005384],
              [587.00961894, 507.97005384],
              [612.99038106, 522.97005384]]]
        ),

        2: np.array(
            [[[150., 544.3375673],
              [137.00961894, 551.8375673],
              [162.99038106, 536.8375673]],

             [[300., 515.47005384],
              [287.00961894, 507.97005384],
              [312.99038106, 522.97005384]],

             [[400., 630.94010768],
              [400., 615.94010768],
              [400., 645.94010768]]]
        ),

        3: np.array(
            [[[150., 255.6624327],
              [137.00961894, 248.1624327],
              [162.99038106, 263.1624327]],

             [[250., 371.13248654],
              [250., 356.13248654],
              [250., 386.13248654]],

             [[200., 515.47005384],
              [212.99038106, 507.97005384],
              [187.00961894, 522.97005384]]]
        ),

        4: np.array(
            [[[400., 111.32486541],
              [400., 96.32486541],
              [400., 126.32486541]],

             [[350., 255.6624327],
              [362.99038106, 248.1624327],
              [337.00961894, 263.1624327]],

             [[200., 284.52994616],
              [212.99038106, 292.02994616],
              [187.00961894, 277.02994616]]]
        ),

        5: np.array(
            [[[650., 255.6624327],
              [662.99038106, 248.1624327],
              [637.00961894, 263.1624327]],

             [[500., 284.52994616],
              [512.99038106, 292.02994616],
              [487.00961894, 277.02994616]],

             [[400., 169.05989232],
              [400., 184.05989232],
              [400., 154.05989232]]]
        ),

        6: np.array(
            [[[650., 544.3375673],
              [662.99038106, 551.8375673],
              [637.00961894, 536.8375673]],

             [[550., 428.86751346],
              [550., 443.86751346],
              [550., 413.86751346]],

             [[600., 284.52994616],
              [587.00961894, 292.02994616],
              [612.99038106, 277.02994616]]]
        )}

    sector_entries = {
        0: np.array(
            [[550., 428.86751346],
             [450., 544.3375673],
             [300., 515.47005384],
             [250., 371.13248654],
             [350., 255.6624327],
             [500., 284.52994616]]
        ),
        1: np.array(
            [[400., 630.94010768],
             [500., 515.47005384],
             [650., 544.3375673]]
        ),
        2: np.array(
            [[200., 515.47005384],
             [350., 544.3375673],
             [400., 688.67513459]]
        ),
        3: np.array(
            [[200., 284.52994616],
             [250., 428.86751346],
             [150., 544.3375673]]
        ),
        4: np.array(
            [[400., 169.05989232],
             [300., 284.52994616],
             [150., 255.6624327]]
        ),
        5: np.array(
            [[600., 284.52994616],
             [450., 255.6624327],
             [400., 111.32486541]]
        ),
        6: np.array(
            [[600., 515.47005384],
             [550., 371.13248654],
             [650., 255.6624327]]
        )}
